[TOC]



## 1. action 缺点

action 在 **共享** 这方面，只能靠 **复制** 这一手段，相当之不优雅



## 2. plugin 基本操作

### 1. 列出所有 可用 plugin

```
fastlane search_plugins
```

### 2. 搜索 指定名称的 plugin

```
fastlane search_plugins [plugin_name]
```

### 3. 添加 plugin

```
fastlane add_plugin [name]
```

### 4. 安装 plugin

```
fastlane install_plugins
```



## 3. 安装使用 蒲公英 plugin

### 1. 进入 iOS 项目 根目录

```
➜  Book ls
Book           Book.xcodeproj Gemfile        Gemfile.lock   fastlane
➜  Book
```

### 2. fastlane init

```
➜  Book fastlane init
[✔] 🚀
[✔] Looking for iOS and Android projects in current directory...
[17:14:52]: Created new folder './fastlane'.
[17:14:52]: Detected an iOS/macOS project in the current directory: 'Book.xcodeproj'
[17:14:52]: -----------------------------
[17:14:52]: --- Welcome to fastlane 🚀 ---
[17:14:52]: -----------------------------
[17:14:52]: fastlane can help you with all kinds of automation for your mobile app
[17:14:52]: We recommend automating one task first, and then gradually automating more over time
[17:14:52]: What would you like to use fastlane for?
1. 📸  Automate screenshots
2. 👩‍✈️  Automate beta distribution to TestFlight
3. 🚀  Automate App Store distribution
4. 🛠  Manual setup - manually setup your project to automate your tasks
?  4
............................
............................
............................
[17:15:40]: To try your new fastlane setup, just enter and run
[17:15:40]: $ fastlane custom_lane
➜  Book
```

### 3. 安装 ==蒲公英== fastlen plugin

> bundle exec fastlane add_plugin pgyer

```
 ~/collect_xxx/Book   master ●  bundle exec fastlane add_plugin pgyer
[✔] 🚀
+-----------------------+---------+--------+
|               Used plugins               |
+-----------------------+---------+--------+
| Plugin                | Version | Action |
+-----------------------+---------+--------+
| fastlane-plugin-pgyer | 0.2.2   | pgyer  |
+-----------------------+---------+--------+

[02:51:38]: Make sure to commit your Gemfile, Gemfile.lock and Pluginfile to version control
Installing plugin dependencies...
Successfully installed plugins
```

- 1) 执行 **安装 plugin**, 并不会 **下载 plugin ruby文件** 到本地目录
- 2) 而是 修改 **fastlane/Pluginfile** . 添加对 **发布** 到 **fastlane plugin repo** 中的 plugin 的 **引用**

### 4. fastlane add_plugin 执行完毕后的 目录结构

```
➜  Book ls -l
total 16
drwxr-xr-x  10 xiongzenghui  staff   320  7 29 13:56 Book
drwxr-xr-x@  5 xiongzenghui  staff   160  7 29 12:57 Book.xcodeproj
-rw-r--r--   1 root          staff   178  7 29 17:16 Gemfile
-rw-r--r--   1 root          staff  4002  7 29 17:16 Gemfile.lock
drwxr-xr-x   5 root          staff   160  7 29 17:16 fastlane
➜  Book 
```

```
➜  Book tree fastlane
fastlane
├── Appfile
├── Fastfile
└── Pluginfile

0 directories, 3 files
➜  Book
```

三个比较重要的文件:

- 1) Gemfile
- 2) Gemfile.lock
- 3) fastlane/**Pluginfile**

### 5. Book/Gemfile

```ruby
source "https://rubygems.org"
gem "fastlane"

# 添加对 ./fastlane/Pluginfile 文件的引用
plugins_path = File.join(File.dirname(__FILE__), 'fastlane', 'Pluginfile')
eval_gemfile(plugins_path) if File.exist?(plugins_path)
```

### 6. Book/fastlane/Pluginfile

```ruby
# Autogenerated by fastlane
#
# Ensure this file is checked in to source control!

# 记录被安装的 fastlane plugin 插件
gem 'fastlane-plugin-pgyer'
```

所有执行**fastlane add_plugin**安装的plugin，都被**记录**在这个ruby文件中。

### 7. Fastfile 调用 plugin

```ruby
default_platform :ios

platform :ios do
before_all do
  # ENV["SLACK_URL"] = "https://hooks.slack.com/services/..."
  cocoapods(use_bundle_exec: false)
end

desc " lane 描述信息:通过蒲公英 fastlane 插件实现上传 APP 到蒲公英"
lane :beta do
  # 1、自动构建iOS项目，打包签名构建导出为ipa
  gym(
    scheme:"xxx",
    workspace: "xxx.xcworkspace",
    export_method: "ad-hoc"
  )
  
  ################################################
  # 2、调用 蒲公英 fastlane plugn
  pgyer(
    api_key: "从蒲公英项目详情中获取的 apikey",
    user_key: "从蒲公英项目详情中获取的 userkey",
    update_description: "本次测试更新的文字说明"
  )
  ################################################
end
```

### 8. 执行 fastlane 命令

```
➜  Book fastlane beta
```

自动打包上传 APP 到蒲公英。

### 9. 成功展示信息

```
[11:23:58]: Successfully exported and compressed dSYM file
# 成功打包
[11:23:58]: Successfully exported and signed the ipa file:
[11:23:58]: /Users/xxxx/Documents/ComponyProject/xxx/xxx/trunk/xxx/xxx.ipa
[11:23:58]: -------------------
[11:23:58]: --- Step: pgyer ---
[11:23:58]: -------------------
[11:23:58]: The pgyer plugin is working.
[11:23:58]: build_file: /Users/xxx/Documents/ComponyProject/xxx/xxxx/trunk/xxxx/xxx.ipa
[11:23:58]: Start upload /Users/xxx/Documents/ComponyProject/xxx/xxx/trunk/xxx/xxx.ipa to pgyer...
# 成功上传到蒲公英，打开下载连接查看
[11:24:02]: Upload success. Visit this URL to see: https://www.pgyer.com/xxxx

+------+---------------------+-------------+
|             fastlane summary             |
+------+---------------------+-------------+
| Step | Action              | Time (in s) |
+------+---------------------+-------------+
| 1    | Verifying required  | 0           |
|      | fastlane version    |             |
| 2    | default_platform    | 0           |
| 3    | cocoapods           | 4           |
| 4    | gym                 | 148         |
| 5    | pgyer               | 4           |
+------+---------------------+-------------+

[11:24:02]: fastlane.tools finished successfully 🎉
```

