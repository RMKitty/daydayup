[TOC]



## 1. lane()

```ruby
# @param lane_name: 唯一的名字
# @param block: 回调block块代码
def lane(lane_name, block)
	....
end
```



## 2. Fastfile 中定义 lane

```ruby
lane :lan1 do
  # 回调代码块中调用其他的action设置函数
end

lane :lan2 do |options|
  # 回调代s码块中调用其他的action设置函数
end
```



## 3. lane 接收 ==参数==

### 1. Fastfile

```ruby
lane :appstore do |options|
  puts options[:version]
  puts options[:build]
end
```

### 2. bundle exec fastlane `<lane_name>` key1:value1 key2:value2

命令行中执行定义的 lane 时, **传递** 参数键值对

```
$ fastlane appstore version:2.4.0 build:2.0
```



## 4. laneA ==调用== laneB (Switching lanes)

```ruby
lane :prepare do
  cocoapods
  match
end

lane :adhoc do
  ···
end

lane :appstore do
  ···
end

desc 'fastlane build'  'fastlane build type:adhoc'
lane :build do |options|
  # 1、直接可调用上面的【prepare lane】
  prepare

  # 2、根据命令行执行 fastlane build type=xxx 的值来调用不同的lane
  case options[:type]
  when 'adhoc'
    adhoc # 调用上面的 prepare lane
  else
    appstore # 调用上面的 prepare lane
  end
end
```



## 5. laneA ==返回值== laneB

```ruby
lane :deploy do |options|
  value = calculate(value: 3)
  puts value # => 5
end

lane :calculate do |options|
  # ...
  2 + options[:value] # the last line will always be the return value
end
```



## 6. ==Stop== executing a lane

```ruby
lane :build do |options|
  next
end
```



## 7. Lane ==Context== Properties

用于在 **不同的 lane** 之间 **传递数据**

```ruby
require 'pp'

lane :lan do
  lane_context[SharedValues::BUILD_NUMBER]                # Generated by `increment_build_number`
  lane_context[SharedValues::VERSION_NUMBER]              # Generated by `increment_version_number`
  lane_context[SharedValues::SNAPSHOT_SCREENSHOTS_PATH]   # Generated by _snapshot_
  lane_context[SharedValues::PRODUCE_APPLE_ID]            # The Apple ID of the newly created app
  lane_context[SharedValues::IPA_OUTPUT_PATH]             # Generated by _gym_
  lane_context[SharedValues::DSYM_OUTPUT_PATH]            # Generated by _gym_
  lane_context[SharedValues::SIGH_PROFILE_PATH]           # Generated by _sigh_
  lane_context[SharedValues::SIGH_UDID]                   # The UDID of the generated provisioning profile
  lane_context[SharedValues::HOCKEY_DOWNLOAD_LINK]        # Generated by `hockey`
  lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]      # Generated by `gradle`
  lane_context[SharedValues::GRADLE_ALL_APK_OUTPUT_PATHS] # Generated by `gradle`
  lane_context[SharedValues::GRADLE_FLAVOR]               # Generated by `gradle`
  lane_context[SharedValues::GRADLE_BUILD_TYPE]           # Generated by `gradle`
end
```



## 8. ==Private== lane

```ruby
lane :production do
  # ...
  build(release: true)
  appstore # Deploy to the AppStore
  # ...
end

lane :beta do
  # ...
  build(release: false)
  crashlytics # Distribute to testers
  # ...
end

private_lane :build do |options|
  # ...
end
```

- 1) production 可以调用 build
- 2) beta 可以调用 build
- 3) 但是 **bundle exec fastlane build** 就会报错, **build** 不允许被 **外部调用**



## 9. 示例

```ruby
desc "打包成企业版ipa"
lane :inhouse do |options|
  # 1.
  update_info_plist(
    plist_path: "GoodFolks/info.plist",
    display_name: "新App名字",
  )

  # 2. 更新urlType 具体用法查询action文件update_info_plist的说明
  update_info_plist(
    xcodeproj: "GoodFolks.xcodeproj",
    plist_path: "GoodFolks/info.plist",
    block: lambda { |plist|
      urlScheme = plist["CFBundleURLTypes"].find{|scheme| scheme["CFBundleURLName"] == "weixin"}
      urlScheme[:CFBundleURLSchemes] = ENV["app_urlschems_weixin"]
    }
  )

  # 3. 设置版本号
  increment_version_number(
    version_number: ENV["app_versionName"]
  )

  # 4. 设置build号，这些都可以写死，也可以不要这些action，也可以从环境变量中获取值
  increment_build_number(
    build_number: ENV["app_versionCode"]
  )

  # 5. 下载和安装匹配的Provision Profile文件的fastlane action
  # 不用你去管那些证书不匹配的事情啦，下载的文件会存在项目根目录的build文件夹下
  cert(output_path:"build")

  # 6. 签名
  sigh(
    app_identifier: ENV["app_applicationId"],
    team_id:"9M8CTWAV8P",
    output_path: "build"
  )

  # 7. 最后就是打包，企业版打包，打包完成后会在项目根目录的build文件夹下生成ipa文件
  gym(
    scheme: "GoodFolks",
    export_method: "enterprise",
    output_directory: "build",
    include_bitcode: false
  )
end
```

