[TOC]



## 1. fastlane 是什么？干什么？

- 当你查看这篇文章时候，我假设你是一个 **ruby 熟练者/ruby gem 开发者/iOS CI 开发者**

- 如果不是，可以门口右转



## 2. fastlane 三个平台下 初始化

![](03.png)

具体 iOS/Android/CoressPlatform 安装 init 自己查看文档.



## 3. Fastfile 中的 ==lane==

### 1. lane()

```ruby
# @param lane_name: 唯一的名字
# @param block: 回调block块代码
def lane(lane_name, block)
	....
end
```

### 2. Fastfile 中定义 lane

```ruby
lane :lan1 do
  # 回调代码块中调用其他的action设置函数
end

lane :lan2 do |options|
  # 回调代s码块中调用其他的action设置函数
end
```

### 3. lane 接收 ==参数==

#### 1. Fastfile

```ruby
lane :appstore do |options|
  puts options[:version]
  puts options[:build]
end
```

#### 2. bundle exec fastlane <lane> key:value key2:value2

命令行中执行定义的 lane 时, **传递** 参数键值对

```
$ fastlane appstore version:2.4.0 build:2.0
```

### 4. lane 之间 ==调用== (Switching lanes)

```ruby
lane :prepare do
  cocoapods
  match
end

lane :adhoc do
  ···
end

lane :appstore do
  ···
end

desc 'fastlane build'  'fastlane build type:adhoc'
lane :build do |options|
  # 1、直接可调用上面的【prepare lane】
  prepare

  # 2、根据命令行执行 fastlane build type=xxx 的值来调用不同的lane
  case options[:type]
  when 'adhoc'
    adhoc # 调用上面的 prepare lane
  else
    appstore # 调用上面的 prepare lane
  end
end
```

### 5. lane 之间 ==返回值==

```ruby
lane :deploy do |options|
  value = calculate(value: 3)
  puts value # => 5
end

lane :calculate do |options|
  # ...
  2 + options[:value] # the last line will always be the return value
end
```

### 6. Stop executing a lane

```ruby
lane :build do |options|
  if cached_build_available?
    UI.important 'Skipping build because a cached build is available!'
    next # skip doing the rest of this lane
  end
  match
  gym
end

private_lane :cached_build_available? do |options|
  # ...
  true
end
```

### 7. Lane ==Context== Properties

```ruby
require 'pp'

lane :lan do
  pp lane_context

  # lane_context[SharedValues::BUILD_NUMBER]                # Generated by `increment_build_number`
  # lane_context[SharedValues::VERSION_NUMBER]              # Generated by `increment_version_number`
  # lane_context[SharedValues::SNAPSHOT_SCREENSHOTS_PATH]   # Generated by _snapshot_
  # lane_context[SharedValues::PRODUCE_APPLE_ID]            # The Apple ID of the newly created app
  # lane_context[SharedValues::IPA_OUTPUT_PATH]             # Generated by _gym_
  # lane_context[SharedValues::DSYM_OUTPUT_PATH]            # Generated by _gym_
  # lane_context[SharedValues::SIGH_PROFILE_PATH]           # Generated by _sigh_
  # lane_context[SharedValues::SIGH_UDID]                   # The UDID of the generated provisioning profile
  # lane_context[SharedValues::HOCKEY_DOWNLOAD_LINK]        # Generated by `hockey`
  # lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]      # Generated by `gradle`
  # lane_context[SharedValues::GRADLE_ALL_APK_OUTPUT_PATHS] # Generated by `gradle`
  # lane_context[SharedValues::GRADLE_FLAVOR]               # Generated by `gradle`
  # lane_context[SharedValues::GRADLE_BUILD_TYPE]           # Generated by `gradle`
end
```

### 8. ENV

```ruby
lane :lan do
  ENV["FASTLANE_PLATFORM_NAME"]
  ENV["FASTLANE_LANE_NAME"]
end
```

### 9. ==Private== lane

```ruby
lane :production do
  # ...
  build(release: true)
  appstore # Deploy to the AppStore
  # ...
end

lane :beta do
  # ...
  build(release: false)
  crashlytics # Distribute to testers
  # ...
end

private_lane :build do |options|
  # ...
end
```

- 1) production => build
- 2) beta => build

### 10. configuration

#### 1. ==Appfile== 默认配置

```
app_identifier "com.used.id"
app_identifier "com.ignored.id"
```

#### 2. ==Fastfile== lane/platform 单独配置

```ruby
for_lane :enterprise do
  app_identifier "com.forlane.enterprise"
end

for_platform :mac do
  app_identifier "com.forplatform.mac"

  for_lane :release do
    app_identifier "com.forplatform.mac.forlane.release"
  end
end
```

#### 3. language 配置

```ruby
locales ['en-US', 'fr-FR', 'ja-JP']

for_lane :screenshots_english_only do
  locales ['en-US']
end

for_lane :screenshots_french_only do
  locales ['fr-FR']
end
```



## 4. eg: Fastfile 构建企业 ipa 流程

### 1. fastlane/Fastfile

```ruby
desc "打包成企业版ipa"
lane :inhouse do |options|
  # 1.
  update_info_plist(
    plist_path: "GoodFolks/info.plist",
    display_name: "新App名字",
  )

  # 2. 更新urlType 具体用法查询action文件update_info_plist的说明
  update_info_plist(
    xcodeproj: "GoodFolks.xcodeproj",
    plist_path: "GoodFolks/info.plist",
    block: lambda { |plist|
      urlScheme = plist["CFBundleURLTypes"].find{|scheme| scheme["CFBundleURLName"] == "weixin"}
      urlScheme[:CFBundleURLSchemes] = ENV["app_urlschems_weixin"]
    }
  )

  # 3. 设置版本号
  increment_version_number(
    version_number: ENV["app_versionName"]
  )

  # 4. 设置build号，这些都可以写死，也可以不要这些action，也可以从环境变量中获取值
  increment_build_number(
    build_number: ENV["app_versionCode"]
  )

  # 5. 下载和安装匹配的Provision Profile文件的fastlane action
  # 不用你去管那些证书不匹配的事情啦，下载的文件会存在项目根目录的build文件夹下
  cert(output_path:"build")

  # 6. 签名
  sigh(
    app_identifier: ENV["app_applicationId"],
    team_id:"9M8CTWAV8P",
    output_path: "build"
  )

  # 7. 最后就是打包，企业版打包，打包完成后会在项目根目录的build文件夹下生成ipa文件
  gym(
    scheme: "GoodFolks",
    export_method: "enterprise",
    output_directory: "build",
    include_bitcode: false
  )
end
```

### 2. fastlane/ 同级目录下执行即可

```
fastlane inhouse
```

注意：如上代码不一定会正常运行，是我很久以前的 fastlane 版本写的，但是可以作为参考拿去修修改改就可以用.



## 5. lane ==hooks==

### 1. before each/all、after each/all、error

```ruby
before_all do |lane, options|
  # ...
end

before_each do |lane, options|
  # ...
end

after_all do |lane, options|
  # ...
end

after_each do |lane, options|
  # ...
end

error do |lane, exception, options|
  if options[:debug]
    puts "Hi :)"
  end
end
```

### 2. 示例

#### 1. Fastfile

```ruby
error do |lane, exception, options|
  UI.message("---------------- [error] #{lane} (#{lane.class})")
end

before_each do |lane, options|
  UI.message("---------------- [before_each] #{lane} (#{lane.class})")
end

before_all do |lane, options|
  UI.message("---------------- [before_all] #{lane} (#{lane.class})")
end

after_all do |lane, options|
  UI.message("---------------- [after_all] #{lane} (#{lane.class})")
end

after_each do |lane, options|
  UI.message("---------------- [after_each] #{lane} (#{lane.class})")
end

lane :test1 do
end

lane :test2 do
end

lane :test3 do
  my_action
end

lane :test do
  test1
  test2
  test3
end
```

#### 2. bundle exec fastlane test

```
 ~/WORKSPACE/toolbox   master  bundle exec fastlane test
[✔] 🚀

[17:01:07]: ------------------------------
[17:01:07]: --- Step: default_platform ---
[17:01:07]: ------------------------------
[17:01:07]: ------------------------------
[17:01:07]: --- Step: default_platform ---
[17:01:07]: ------------------------------
[17:01:07]: Driving the lane 'test' 🚀
[17:01:07]: ---------------- [before_all] test (Symbol)
[17:01:07]: ---------------- [before_each] test (Symbol)
[17:01:07]: ---------------- [before_each] test1 (Symbol)
[17:01:07]: ----------------------------------
[17:01:07]: --- Step: Switch to test1 lane ---
[17:01:07]: ----------------------------------
[17:01:07]: Cruising over to lane 'test1' 🚖
[17:01:07]: ---------------- [after_each] test1 (Symbol)
[17:01:07]: Cruising back to lane 'test' 🚘
[17:01:07]: ---------------- [before_each] test2 (Symbol)
[17:01:07]: ----------------------------------
[17:01:07]: --- Step: Switch to test2 lane ---
[17:01:07]: ----------------------------------
[17:01:07]: Cruising over to lane 'test2' 🚖
[17:01:07]: ---------------- [after_each] test2 (Symbol)
[17:01:07]: Cruising back to lane 'test' 🚘
[17:01:07]: ---------------- [before_each] test3 (Symbol)
[17:01:07]: ----------------------------------
[17:01:07]: --- Step: Switch to test3 lane ---
[17:01:07]: ----------------------------------
[17:01:07]: Cruising over to lane 'test3' 🚖
[17:01:07]: ----------------
[17:01:07]: --- Step: my ---
[17:01:07]: ----------------
[17:01:07]: my_action: /Users/xiongzenghui/WORKSPACE/toolbox
[17:01:07]: ---------------- [after_each] test3 (Symbol)
[17:01:07]: Cruising back to lane 'test' 🚘
[17:01:07]: ---------------- [after_each] test (Symbol)
[17:01:07]: ---------------- [after_all] test (Symbol)

+------+----------------------+-------------+
|             fastlane summary              |
+------+----------------------+-------------+
| Step | Action               | Time (in s) |
+------+----------------------+-------------+
| 1    | default_platform     | 0           |
| 2    | default_platform     | 0           |
| 3    | Switch to test1 lane | 0           |
| 4    | Switch to test2 lane | 0           |
| 5    | Switch to test3 lane | 0           |
| 6    | my                   | 0           |
+------+----------------------+-------------+

[17:01:07]: fastlane.tools finished successfully 🎉
```

主要关注 **lane , action , plugin** 状态改变 hook 打印信息:

```
[17:01:07]: ---------------- [before_all] test (Symbol)
[17:01:07]: ---------------- [before_each] test (Symbol)
[17:01:07]: ---------------- [before_each] test1 (Symbol)
[17:01:07]: ---------------- [after_each] test1 (Symbol)
[17:01:07]: ---------------- [before_each] test2 (Symbol)
[17:01:07]: ---------------- [after_each] test2 (Symbol)
[17:01:07]: ---------------- [before_each] test3 (Symbol)
[17:01:07]: ---------------- [after_each] test3 (Symbol)
[17:01:07]: ---------------- [after_each] test (Symbol)
[17:01:07]: ---------------- [after_all] test (Symbol)
```



## 6. fastlane_require() 替代 require() 载入 ==第三方 gem==

### 1. 只是在 ==Fastfile== 中使用 fastlane_require()

- 1) If you're using a **third party gem** in your **Fastfile**

- 2) it is **recommended** to use **fastlane_require** instead of **require**

- 3) **fastlane_require** will: (好处)
  - 1) **Verify** the **gem** is **installed**
  - 2) **Show** installation instructions **if not installed**
  - 3) **Require** the gem (**like require** does)

比如如果需要在你的 Fastfile 中使用 **hike** 这个 gem , 就这样写:

```ruby
fastlane_require 'hike'

lane :release do
  # Do stuff with hike
end
```

### 2. action/plugin 中仍然使用 require()

```c
module Fastlane
  module Actions
    module SharedValues
      GITLAB_MR_ADD_NOTE_CUSTOM_VALUE = :GITLAB_MR_ADD_NOTE_CUSTOM_VALUE
    end

    # fastlane_require 'gitlab' #=> 错误
    require 'gitlab' #=> 正确

    class GitlabMrAddNoteAction < Action
      ......
    end
  end
end
```



## 7. Fastfile 代码封装

### 1. 如果全部堆积在 Fastfile 一个文件内, 会造成代码爆炸

> xx/fastlane/Fastfile

```ruby
def func1
  ......
end

def func2
  ......
end

......

def funcN
  ......
end

lane :entry do
  action1
  action2
  .......
  actionN

  plugin1
  plugin2
  .......
  pluginN

  func1
  func2
  .......
  funcN
end
```

很多定义在 Fastfile 文件内的 **方法** 只能通过 **拷贝** 到其他的 Fastfile 文件中使用.

### 2. fastlane 项目结构

#### 1. WORKSPACE/toolbox/ 目录

```
 ~/WORKSPACE/toolbox   master ●  ll
-rw-r--r--   1 xiongzenghui  staff   1.2K  7 11 15:06 Gemfile
-rw-r--r--   1 xiongzenghui  staff   8.1K  7 15 18:02 Gemfile.lock
-rw-r--r--   1 xiongzenghui  staff   362B  7 11 14:54 Makefile
-rw-r--r--   1 xiongzenghui  staff   1.2K  7 15 17:00 README.md
drwxr-xr-x  12 xiongzenghui  staff   384B  7 15 23:29 fastlane
```

#### 2. WORKSPACE/toolbox/fastlane/ 目录

```
 ~/WORKSPACE/toolbox/fastlane   master ●  ll
-rw-r--r--   1 xiongzenghui  staff   230B  7 11 13:05 Appfile
-rw-r--r--   1 xiongzenghui  staff   2.7K  7 15 23:55 Fastfile
drwxr-xr-x  13 xiongzenghui  staff   416B  7 15 16:26 actions
drwxr-xr-x   6 xiongzenghui  staff   192B  7 15 23:56 helper
```

#### 3. WORKSPACE/toolbox/fastlane/helper

```
 ~/WORKSPACE/toolbox/fastlane/helper   master ●  ll
total 32
-rw-r--r--  1 xiongzenghui  staff    53B  7 15 23:56 cry.rb
-rw-r--r--  1 xiongzenghui  staff    53B  7 15 23:49 eat.rb
-rw-r--r--  1 xiongzenghui  staff    53B  7 15 23:50 walk.rb
```

### 3. 使用 ==lane== 封装可重用代码

#### 1. WORKSPACE/toolbox/fastlane/helper/eat.rb

```ruby
lane :eat do
  UI.message("[lane] [eat] .......")
end
```

#### 2. WORKSPACE/toolbox/fastlane/helper/walk.rb

```ruby
lane :run do
  UI.message("[lane] [walk] .......")
end
```

#### 3. WORKSPACE/toolbox/fastlane/helper/cry.rb

```ruby
lane :cry do
  UI.message("[lane] [cry] .......")
end
```

#### 4. WORKSPACE/toolbox/fastlane/Fastfile

```ruby
import 'helper/eat.rb'
import 'helper/walk.rb'
import 'helper/cry.rb'

lane :test do
  eat
  walk
  cry
end
```

#### 5. bundle exec fastlane test

```ruby
 ~/WORKSPACE/toolbox   master ●  bundle exec fastlane test
[✔] 🚀

[00:02:43]: Driving the lane 'test' 🚀
[00:02:43]: --------------------------------
[00:02:43]: --- Step: Switch to eat lane ---
[00:02:43]: --------------------------------
[00:02:43]: Cruising over to lane 'eat' 🚖
[00:02:43]: [lane] [eat] .......
[00:02:43]: Cruising back to lane 'test' 🚘
[00:02:43]: ---------------------------------
[00:02:43]: --- Step: Switch to walk lane ---
[00:02:43]: ---------------------------------
[00:02:43]: Cruising over to lane 'walk' 🚖
[00:02:43]: [lane] [walk] .......
[00:02:43]: Cruising back to lane 'test' 🚘
[00:02:43]: --------------------------------
[00:02:43]: --- Step: Switch to cry lane ---
[00:02:43]: --------------------------------
[00:02:43]: Cruising over to lane 'cry' 🚖
[00:02:43]: [lane] [cry] .......
[00:02:43]: Cruising back to lane 'test' 🚘

+------+---------------------+-------------+
|             fastlane summary             |
+------+---------------------+-------------+
| Step | Action              | Time (in s) |
+------+---------------------+-------------+
| 1    | Switch to eat lane  | 0           |
| 2    | Switch to walk lane | 0           |
| 3    | Switch to cry lane  | 0           |
+------+---------------------+-------------+

[00:02:43]: fastlane.tools finished successfully 🎉
```

- 1) Driving the lane '**test**'
- 2) Step: Switch to **eat** lane
- 3) Step: Switch to **walk** lane
- 4) Step: Switch to **cry** lane

#### 6. ==不能使用== 这种方式

- 虽然可以在 lane 中, 直接使用 fastlane UI.message、UI.success …. 等方法.
- 但是会导致 **lane 重复定义**

```
 ~/WORKSPACE/toolbox  bundle exec fastlane test
[✔] 🚀

[15:35:00]: ------------------------------
[15:35:00]: --- Step: default_platform ---
[15:35:00]: ------------------------------

[!] Lane 'demo' was defined multiple times!
```

### 4. 使用 ==action (其他目录下)== 封装可重用代码

#### 1. WORKSPACE/toolbox/fastlane/helper/eat.rb

```ruby
module Fastlane
  module Actions
    class EatAction < Action
      def self.run(params)
        UI.message("[action] [eat] .......")
      end
    end
  end
end
```

#### 2. WORKSPACE/toolbox/fastlane/helper/walk.rb

```ruby

```

#### 3. WORKSPACE/toolbox/fastlane/helper/cry.rb

```ruby

```

#### 4. WORKSPACE/toolbox/fastlane/Fastfile

```ruby
#import 'helper/eat.rb'

#  应该使用这种方式，导入【其他目录】下的 action.rb 文件
#actions_path '../custom_actions_folder/'
actions_path 'helper/'

lane :test do
  eat
end
```

#### 5. bundle exec fastlane test

```ruby
 ~/WORKSPACE/toolbox   master ●  bundle exec fastlane test
[✔] 🚀

[00:21:05]: Driving the lane 'test' 🚀
[00:21:05]: --------------------------------
[00:21:05]: --- Step: Switch to eat lane ---
[00:21:05]: --------------------------------
[00:21:05]: Cruising over to lane 'eat' 🚖
[00:21:05]: Cruising back to lane 'test' 🚘

+------+--------------------+-------------+
|            fastlane summary             |
+------+--------------------+-------------+
| Step | Action             | Time (in s) |
+------+--------------------+-------------+
| 1    | Switch to eat lane | 0           |
+------+--------------------+-------------+

[00:21:05]: fastlane.tools finished successfully 🎉
```

#### 6. 总结

发现最终把 action 当做 **lane** 执行的.

### 5. 使用 ==Fastlane Helper== 封装可重用代码

#### 1. WORKSPACE/toolbox/fastlane/helper/eat.rb

```ruby
require 'fastlane_core/ui/ui'

module Fastlane
  UI = FastlaneCore::UI unless Fastlane.const_defined?("UI")
  module Helper
    class EatHelper
      def self.show_message
        UI.message("[helper] [eat] .......")
      end
    end
  end
end
```

#### 2. WORKSPACE/toolbox/fastlane/helper/happy.rb

```ruby
require 'fastlane_core/ui/ui'

module Fastlane
  UI = FastlaneCore::UI unless Fastlane.const_defined?("UI")
  module Helper
    class HappyHelper
      def self.show_message
        UI.message("[helper] [happy] .......")
      end
    end
  end
end
```

#### 3. WORKSPACE/toolbox/fastlane/helper/cry.rb

```ruby
require 'fastlane_core/ui/ui'

module Fastlane
  UI = FastlaneCore::UI unless Fastlane.const_defined?("UI")
  module Helper
    class CryHelper
      def self.show_message
        UI.message("[helper] [cry] .......")
      end
    end
  end
end
```

#### 4. WORKSPACE/toolbox/fastlane/Fastfile

```ruby
require_relative 'helper/eat.rb'
require_relative 'helper/happy.rb'
require_relative 'helper/cry.rb'

lane :test do
  Helper::EatHelper::show_message
  # Helper::WalkHelper::show_message
  Helper::HappyHelper::show_message
  Helper::CryHelper::show_message
end
```

#### 5. bundle exec fastlane test

```ruby
 ~/WORKSPACE/toolbox   master ●  bundle exec fastlane test
[✔] 🚀

[00:13:45]: Driving the lane 'test' 🚀
[00:13:45]: [helper] [eat] .......
[00:13:45]: [helper] [happy] .......
[00:13:45]: [helper] [cry] .......
[00:13:45]: fastlane.tools finished successfully 🎉
```

#### 6. 总结

都按照 **helper** 执行的.

### 6. 总结

- 1) 应该使用 **action (本地)** 或者 **plugin (远程)** 封装可重用的代码
- 2) action 和 plugin **路径** 问题
  - **不应该** 依赖外部 **lane** 调用时的 **相对路径**
  - 而 **应该** 由外部 **lane** 传入 **绝对路径**



## 8. 代码定义 lane

### 1. 示例

```ruby
require 'fastlane'

Fastlane::FastFile.new.parse("lane :test do
  UI.message('hello')
end").runner.execute(:test)
```

```
 ~/Desktop  ruby main.rb
[11:15:16]: Driving the lane 'test' 🚀
[11:15:16]: hello
```

### 2. fastlane plugin spec

```ruby
require 'spec_helper'
require 'webmock/rspec'

describe Fastlane::Actions::CiBuildNumberAction do
  describe "xxx" do
    it "xxx" do
      ENV['TRAVIS'] = '1'
      ENV['TRAVIS_BUILD_NUMBER'] = '42'

      result = Fastlane::FastFile.new.parse("lane :test do
        ci_build_number
      end").runner.execute(:test)

      expect(result).to eq('42')

      ENV.delete('TRAVIS')
      ENV.delete('TRAVIS_BUILD_NUMBER')
    end
  end
end
```

